name: Dockit Development Build

on:
  workflow_dispatch:
    inputs:
      branch:
        type: string
        default: 'main'
        description: 'branch'
        required: true
      release-new-build:
        type: boolean
        default: false
        description: 'Release new build'
        required: true
      version:
        type: string
        default: ''
        description: 'Version'
        required: false

jobs:
  pre-release:
    name: Development Build
    runs-on: macos-14
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch }}

      - name: ğŸ”§ Select Xcode
        run: sudo xcode-select -s "/Applications/Xcode_16.2.app"
        
      - name: ğŸ” è®¾ç½®è¯ä¹¦
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASE64 }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # åˆ›å»ºä¸´æ—¶è¯ä¹¦æ–‡ä»¶
          echo $CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          
          # åˆ›å»ºä¸´æ—¶keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # å¯¼å…¥è¯ä¹¦åˆ°keychain
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # å…è®¸codesignè®¿é—®keychain
          security list-keychains -s build.keychain
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm certificate.p12

      - name: ğŸ› ï¸ Build Dockit
        run: |
          mkdir -p dist # ç¡®ä¿ dist ç›®å½•å­˜åœ¨ï¼Œç”¨äºå­˜æ”¾æœ€ç»ˆçš„ zip æ–‡ä»¶
          xcodebuild \
            build \
            -project Dockit.xcodeproj/ \
            -scheme "Dockit" \
            -destination 'generic/platform=macOS' \
            -configuration Release \
            CONFIGURATION_BUILD_DIR=$(pwd)/build/Release \
            CODE_SIGN_IDENTITY="Apple Development" \
            CODE_SIGNING_REQUIRED=YES \
            DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM_ID }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain" \
            SKIP_PACKAGE_DEPENDENCIES_RESOLUTION=YES \
            PACKAGE_SKIP_SIGNING=YES

      - name: ğŸ¤ Compress Dockit.app
        run: |
          ditto -c -k --sequesterRsrc --keepParent "build/Release/Dockit.app" "dist/Dockit.zip"
      
      - name: â¬†ï¸ Upload Dockit
        uses: actions/upload-artifact@v4
        with:
          name: Dockit
          path: dist/Dockit.zip

      - name: ğŸ¤” Determine Tag
        id: determine_tag
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const versionInput = '${{ inputs.version }}';
            const releaseNewBuild = '${{ inputs.release-new-build }}' === 'true';

            let tagName = 'prerelease';
            let createNewTag = false; // æŒ‡ç¤ºæ˜¯å¦æ˜¯æ–°ç‰ˆæœ¬å‘å¸ƒï¼ˆé prerelease æ›´æ–°ï¼‰
            let isPrereleaseOnGitHub = true; // æ‰€æœ‰æ„å»ºéƒ½æ ‡è®°ä¸º GitHub é¢„å‘å¸ƒ

            if (releaseNewBuild) {
              createNewTag = true;
              if (versionInput) {
                tagName = versionInput;
                console.log(`Using provided version as tag: ${tagName}`);
              } else {
                console.log('No version provided, attempting to determine next tag...');
                // è·å–ä»“åº“æ‰€æœ‰æ ‡ç­¾
                const tagsResponse = await github.rest.repos.listTags({ owner, repo });
                const tags = tagsResponse.data.map(tag => tag.name);
                console.log(`Found tags: ${tags.join(', ')}`);

                // ç­›é€‰å‡ºè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ (X.Y.Z æˆ– vX.Y.Z)
                const semverTags = tags
                  .filter(name => /^(v?\d+\.\d+\.\d+)$/.test(name))
                  .sort((a, b) => {
                    // ç®€å•çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ’åº
                    const parseVer = (s) => s.replace(/^v/, '').split('.').map(Number);
                    const verA = parseVer(a);
                    const verB = parseVer(b);
                    for (let i = 0; i < 3; i++) {
                      if (verA[i] !== verB[i]) return verA[i] - verB[i];
                    }
                    return 0;
                  });

                console.log(`Found semver tags: ${semverTags.join(', ')}`);

                if (semverTags.length > 0) {
                  const latestTag = semverTags[semverTags.length - 1];
                  console.log(`Latest semver tag: ${latestTag}`);
                  const hasV = latestTag.startsWith('v');
                  const parts = latestTag.replace(/^v/, '').split('.').map(Number);
                  parts[2]++; // å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
                  tagName = (hasV ? 'v' : '') + parts.join('.');
                  console.log(`Calculated next tag: ${tagName}`);
                } else {
                  tagName = '0.0.1'; // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡ç­¾ï¼Œä» 0.0.1 å¼€å§‹
                  console.log('No existing semver tags found, starting with:', tagName);
                }
              }
            } else {
               console.log('Not releasing a new build version, using tag: prerelease');
            }

            // è®¾ç½®è¾“å‡º
            core.setOutput('tag_name', tagName);
            core.setOutput('create_new_tag', createNewTag.toString()); // è¾“å‡ºä¸ºå­—ç¬¦ä¸² "true" æˆ– "false"
            core.setOutput('is_prerelease', isPrereleaseOnGitHub.toString());

      - name: Setup node
        if: steps.determine_tag.outputs.create_new_tag == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate changelog
        if: steps.determine_tag.outputs.create_new_tag == 'true'
        id: create_release
        run: npx changelogithub --name ${{ steps.determine_tag.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¥³ Publish Build Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: dist/Dockit.zip
          commit: ${{ inputs.branch }}
          bodyFile: ${{ steps.determine_tag.outputs.create_new_tag == 'true' && 'CHANGELOG.md' || '' }}
          name: "Build: ${{ steps.determine_tag.outputs.tag_name }}"
          prerelease: ${{ steps.determine_tag.outputs.is_prerelease == 'true' }}
          tag: ${{ steps.determine_tag.outputs.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
